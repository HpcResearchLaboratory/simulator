#!/bin/env bash

BENCHMARKS_DIR=${1:-"./assets/benchmarks"}
RESULTS_DIR=${1:-"./assets/results"}

# Case 1: gpu sync vs async
mkdir -p "$RESULTS_DIR"/case1/{nsys,hyperfine}/{small,medium,large,larger}

# Case 1.1: NVIDIA nsight systems
# Case 1.1.1: sync
for i in small medium large larger; do
  nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case1/nsys/${i}/sync.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/sync -i ./assets/input/"$i"
done

# Case 1.1.2: async
for i in small medium large larger; do
  CUDA_VISIBLE_DEVICES=0 nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    -o "$RESULTS_DIR"/case1/nsys/${i}/async_1gpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/async -i ./assets/input/"$i"
done

# Caso 1.1.3: async 2 GPUs
for i in small medium large larger; do
  CUDA_VISIBLE_DEVICES=0,1 nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    -o "$RESULTS_DIR"/case1/nsys/${i}/async_2gpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/async -i ./assets/input/"$i"
done

# Case 1.2: hyperfine comparsion
for i in small medium large larger; do
  hyperfine \
    "${BENCHMARKS_DIR}/case1/sync -i ./assets/input/${i}" \
    --command-name sync \
    "CUDA_VISIBLE_DEVICES=0 ${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name async_1gpu \
    "CUDA_VISIBLE_DEVICES=0,1 ${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name async_2gpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.json \
    --export-markdown "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.md \
    --export-csv "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.csv
done
