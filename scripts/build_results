#!/bin/env bash

BENCHMARKS_DIR=${1:-"./assets/benchmarks"}
RESULTS_DIR=${1:-"./assets/results"}

# Case 1: gpu sync vs async
mkdir -p "$RESULTS_DIR"/case1/{nsys,hyperfine}/{small,medium,large,larger}

# Case 1.1: NVIDIA nsight systems
for i in small medium large larger; do
  # Case 1.1.1: sync
  CUDA_VISIBLE_DEVICES=0 nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case1/nsys/${i}/sync.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/sync -i ./assets/input/"$i"

  # Case 1.1.2: async
  CUDA_VISIBLE_DEVICES=0 nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    -o "$RESULTS_DIR"/case1/nsys/${i}/async_1gpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/async -i ./assets/input/"$i"

  # Caso 1.1.3: async 2 GPUs
  CUDA_VISIBLE_DEVICES=0,1 nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    -o "$RESULTS_DIR"/case1/nsys/${i}/async_2gpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case1/async -i ./assets/input/"$i"

  # Case 1.2: hyperfine comparsion
  hyperfine \
    "CUDA_VISIBLE_DEVICES=0 ${BENCHMARKS_DIR}/case1/sync -i ./assets/input/${i}" \
    --command-name sync \
    "CUDA_VISIBLE_DEVICES=0 ${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name async_1gpu \
    "CUDA_VISIBLE_DEVICES=0,1 ${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name async_2gpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.json \
    --export-markdown "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.md \
    --export-csv "$RESULTS_DIR"/case1/hyperfine/${i}/comparison.csv
done


# Case 2: operators on cpu vs gpu
mkdir -p "$RESULTS_DIR"/case2/{nsys,hyperfine}/{small,medium,large,larger}/{insertion,movement,contact,transition}

for i in small medium large larger; do
  nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case2/nsys/${i}/insertion_cpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case2/insertion -i ./assets/input/"$i"

  hyperfine \
    "${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name insertion_gpu \
    "${BENCHMARKS_DIR}/case2/insertion -i ./assets/input/${i}" \
    --command-name insertion_cpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case2/hyperfine/${i}/insertion/comparison.json \
    --export-markdown "$RESULTS_DIR"/case2/hyperfine/${i}/insertion/comparison.md \
    --export-csv "$RESULTS_DIR"/case2/hyperfine/${i}/insertion/comparison.csv

  nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case2/nsys/${i}/movement_cpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case2/movement -i ./assets/input/"$i"
  hyperfine \
    "${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name movement_gpu \
    "${BENCHMARKS_DIR}/case2/movement -i ./assets/input/${i}" \
    --command-name movement_cpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case2/hyperfine/${i}/movement/comparison.json \
    --export-markdown "$RESULTS_DIR"/case2/hyperfine/${i}/movement/comparison.md \
    --export-csv "$RESULTS_DIR"/case2/hyperfine/${i}/movement/comparison.csv

  nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case2/nsys/${i}/contact_cpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case2/contact -i ./assets/input/"$i"
  hyperfine \
    "${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name contact_gpu \
    "${BENCHMARKS_DIR}/case2/contact -i ./assets/input/${i}" \
    --command-name contact_cpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case2/hyperfine/${i}/contact/comparison.json \
    --export-markdown "$RESULTS_DIR"/case2/hyperfine/${i}/contact/comparison.md \
    --export-csv "$RESULTS_DIR"/case2/hyperfine/${i}/contact/comparison.csv

  nsys profile \
    --trace cuda,nvtx,mpi,oshmem,openacc,openmp \
    --cuda-memory-usage=true \
    --gpuctxsw=true \
    -o "$RESULTS_DIR"/case2/nsys/${i}/transition_cpu.nsys-rep \
    "${BENCHMARKS_DIR}"/case2/transition -i ./assets/input/"$i"
  hyperfine \
    "${BENCHMARKS_DIR}/case1/async -i ./assets/input/${i}" \
    --command-name transition_gpu \
    "${BENCHMARKS_DIR}/case2/transition -i ./assets/input/${i}" \
    --command-name transition_cpu \
    --warmup 3 \
    --export-json "$RESULTS_DIR"/case2/hyperfine/${i}/transition/comparison.json \
    --export-markdown "$RESULTS_DIR"/case2/hyperfine/${i}/transition/comparison.md \
    --export-csv "$RESULTS_DIR"/case2/hyperfine/${i}/transition/comparison.csv
done
